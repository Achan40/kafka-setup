name: Build and Push Dockerfiles to ECR

on:
  push:
    branches:
      - dev
permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: kafka-setup

    steps:
      # 1. Checkout Repo
      - name: Checkout repo
        uses: actions/checkout@v5

      # 2. configure AWS credentials
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-2
          role-to-assume: ${{ secrets.CI_CD_ROLE_ARN }}

      - name: Authenticate Docker to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          files=$(find . -type f -iname "Dockerfile")
          echo "dockerfiles=$files" >> $GITHUB_OUTPUT

      - name: Build and Push Images
        run: |
            GIT_SHA=${GITHUB_SHA::7}   # short commit SHA

            for file in ${{ steps.find-dockerfiles.outputs.dockerfiles }}; do
            dir=$(dirname "$file")
            name=$(basename "$dir" | tr '[:upper:]' '[:lower:]')

            echo "Building image for $file -> sending to repo: ${{ secrets.ECR_REPO_NAME_DEV }}"

            BASE_URI="${{ steps.ecr-login.outputs.registry }}/${{ secrets.ECR_REPO_NAME_DEV }}"
            IMAGE_LATEST="$BASE_URI:${name}-latest"
            IMAGE_SHA="$BASE_URI:${name}-${GIT_SHA}"

            # Build once, tag twice
            docker build -t "$IMAGE_LATEST" -t "$IMAGE_SHA" "$dir"

            # Push both tags
            docker push "$IMAGE_LATEST"
            docker push "$IMAGE_SHA"
            done