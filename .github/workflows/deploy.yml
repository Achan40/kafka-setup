name: Deploy Infrastructure

on:
  push:
    branches:
      - dev   # runs pipeline when code is pushed to main
permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: kafka-setup

    steps:
      # 1. Checkout Repo
      - name: Checkout repo
        uses: actions/checkout@v5

      # 2. configure AWS credentials
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-2
          role-to-assume: ${{ secrets.CI_CD_ROLE_ARN }}
      
      # 3. Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.1
      
       # 4. Install Terragrunt
      - name: Install Terragrunt
        run: |
          TG_VERSION=0.86.2
          wget https://github.com/gruntwork-io/terragrunt/releases/download/v${TG_VERSION}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      # 5. Run Terragrunt plan (for visibility)
      - name: Terragrunt Plan
        run: |
          cd infra/live/dev
          terragrunt plan --all -out=tfplan

      # 6. Apply on dev (auto-approve since this is CI/CD)
      - name: Terragrunt Apply
        if: github.ref == 'refs/heads/dev'
        run: |
          cd infra/live/dev
          terragrunt apply --all -auto-approve tfplan